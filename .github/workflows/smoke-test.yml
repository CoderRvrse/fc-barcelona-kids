name: Smoke Test
on:
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types:
      - completed

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Smoke Test Production
        run: |
          ROOT="https://coderrvrse.github.io/fc-barcelona-kids"

          echo "🔍 Fetching live page..."
          curl -fsSL "$ROOT/" > page.html

          echo "✅ Testing v23.1 assets..."
          grep -q 'styles/main.css?v=23.1' page.html || (echo "❌ CSS v23.1 missing" && exit 1)
          grep -q 'scripts/main.js?v=23.1' page.html || (echo "❌ JS v23.1 missing" && exit 1)

          echo "✅ Testing core elements..."
          grep -q 'id="hero"' page.html || (echo "❌ Hero missing" && exit 1)
          grep -q 'id="squadGrid"' page.html || (echo "❌ Squad grid missing" && exit 1)
          grep -q 'id="flabPitch"' page.html || (echo "❌ Formation Lab pitch missing" && exit 1)
          grep -q 'FC BARCELONA' page.html || (echo "❌ Title missing" && exit 1)

          echo "✅ Testing JSON endpoint..."
          curl -fsSL "$ROOT/data/squad.json" > squad.json
          PLAYER_COUNT=$(grep -c '"id":' squad.json)
          if [ "$PLAYER_COUNT" -lt 12 ]; then
            echo "❌ Expected ≥12 players, found $PLAYER_COUNT"
            exit 1
          fi

          echo "✅ Testing no blank title regression..."
          ! grep -q '>C BARCELONA<' page.html || (echo "❌ Blank title regression detected" && exit 1)

          echo "🎉 All smoke tests passed!"
          echo "- Assets: v23.1 ✅"
          echo "- Elements: Hero, Squad Grid, Formation Lab ✅"
          echo "- Players: $PLAYER_COUNT ✅"
          echo "- No regressions ✅"