name: Smoke Test
on:
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types:
      - completed

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Smoke Test Production
        run: |
          ROOT="https://coderrvrse.github.io/fc-barcelona-kids"

          echo "ðŸ” Fetching live page..."
          curl -fsSL "$ROOT/" > page.html

          echo "âœ… Testing v23.1 assets..."
          grep -q 'styles/main.css?v=23.1' page.html || (echo "âŒ CSS v23.1 missing" && exit 1)
          grep -q 'scripts/main.js?v=23.1' page.html || (echo "âŒ JS v23.1 missing" && exit 1)

          echo "âœ… Testing core elements..."
          grep -q 'id="hero"' page.html || (echo "âŒ Hero missing" && exit 1)
          grep -q 'id="squadGrid"' page.html || (echo "âŒ Squad grid missing" && exit 1)
          grep -q 'id="flabPitch"' page.html || (echo "âŒ Formation Lab pitch missing" && exit 1)
          grep -q 'FC BARCELONA' page.html || (echo "âŒ Title missing" && exit 1)

          echo "âœ… Testing JSON endpoint..."
          curl -fsSL "$ROOT/data/squad.json" > squad.json
          PLAYER_COUNT=$(grep -c '"id":' squad.json)
          if [ "$PLAYER_COUNT" -lt 12 ]; then
            echo "âŒ Expected â‰¥12 players, found $PLAYER_COUNT"
            exit 1
          fi

          echo "âœ… Testing no blank title regression..."
          ! grep -q '>C BARCELONA<' page.html || (echo "âŒ Blank title regression detected" && exit 1)

          echo "ðŸŽ‰ All smoke tests passed!"
          echo "- Assets: v23.1 âœ…"
          echo "- Elements: Hero, Squad Grid, Formation Lab âœ…"
          echo "- Players: $PLAYER_COUNT âœ…"
          echo "- No regressions âœ…"