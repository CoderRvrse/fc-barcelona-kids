name: Auto Regression Guard

on:
  workflow_run:
    workflows: [ "Deploy to GitHub Pages" ]
    types: [ completed ]

permissions:
  contents: read
  issues: write

jobs:
  noop_success:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "Deploy succeeded; nothing to do."

  on_failure:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Save event payload
        run: |
          mkdir -p ci
          echo '${{ toJson(github.event) }}' > ci/event.json
      - name: Upload debug payload
        uses: actions/upload-artifact@v4
        with:
          name: auto-regression-debug
          path: ci/event.json
          retention-days: 14

      - name: Open regression issue
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const body = [
              `**Regression detected** in "${run.name}"`,
              `Conclusion: **${run.conclusion}**`,
              `Commit: ${run.head_sha}`,
              `By: ${run.actor?.login}`,
              `Run: ${run.html_url}`
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Regression: ${run.name} #${run.id} failed`,
              body,
              labels: ['ci','regression']
            });